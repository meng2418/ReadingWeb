// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // 或 "mysql", "postgresql"
  url      = env("DATABASE_URL")
}

model User_info {
  userId          Int       @id @default(autoincrement())
  username    String    @unique
  email       String?   @unique
  phone       String?   @unique
  password    String?
  avatar      String?
  bio         String?
  isMember    Boolean   @default(false)
  coins       Int       @default(0) // 书币
  totalReadingTime Int  @default(0) // 总阅读时长(分钟)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // 关联关系
  bookshelf   Bookshelf[]
  readingProgress ReadingProgress[]
  notes       Note[]
  bookmarks   Bookmark[]
  posts       Post[]
  comments    Comment[]
  likes       Like[]
  follows     Follow[]   @relation("Follower")
  followers   Follow[]   @relation("Following")
  messages    Message[]
  readingStats ReadingStatus[]
  memberInfo           Member_info?
  trialCardIncentive   TrialCardIncentive_info?
}

model Member_info {
  memberId             Int               @id @default(autoincrement())
  userId               Int               @unique
  startDate            DateTime
  endDate              DateTime
  isAutoRenew          Boolean           @default(false)
  createdAt            DateTime          @default(now())

  user                 User_info         @relation(fields: [userId], references: [userId])
}

model Book_info {
  bookId          Int       @id @default(autoincrement())
  title       String
  author      String
  cover       String?
  description String?   @db.Text
  categoryId  Int
  publisher   String?
  publishDate DateTime?
  isbn        String?
  wordCount   Int       // 字数
  price       Int       @default(0) // 书币价格
  isFree      Boolean   @default(false)
  rating      Float     @default(0) // 推荐值
  readCount   Int       @default(0) // 阅读人数
  createdAt   DateTime  @default(now())
  
  // 关联关系
  category    Category  @relation(fields: [categoryId], references: [id])
  chapters    Chapter[]
  bookshelf   Bookshelf[]
  readingProgress ReadingProgress[]
  notes       Note[]
  bookmarks   Bookmark[]
  posts       Post[]
  comments    Comment[]
}

model Category_info {
  categoryId    Int    @id @default(autoincrement())
  name  String
  books Book[]
}

model Chapter_info {
  chapterId        Int      @id @default(autoincrement())
  title     String
  content   String   @db.Text
  order     Int
  bookId    Int
  createdAt DateTime @default(now())
  access    ChapterAccess_info?
  
  book      Book     @relation(fields: [bookId], references: [id])
  notes     Note[]
  bookmarks Bookmark[]
}

model ChapterAccess_info {
  accessId             Int               @id @default(autoincrement())
  chapterId            Int               @unique
  
  // 访问级别：free, trial, member (这里需要同时检查用户是否有有效的 trialEndDate 或 member.endDate)
  accessLevel          String            @default("free") 
  
  chapter              Chapter_info      @relation(fields: [chapterId], references: [chapterId])
}

model Bookshelf_info {
  bookshelfid        Int      @id @default(autoincrement())
  userId    Int
  bookId    Int
  status    String   @default("reading") // reading, unread, finished
  addedAt   DateTime @default(now())
  lastReadAt DateTime?
  
  user      User     @relation(fields: [userId], references: [id])
  book      Book     @relation(fields: [bookId], references: [id])
  
  @@unique([userId, bookId])
}

model ReadingProgress_info {
  readingprogressid          Int      @id @default(autoincrement())
  userId      Int
  bookId      Int
  chapterId   Int?
  currentPage Int      @default(1)
  progress    Float    @default(0)  // 0-1
  lastReadAt  DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  book        Book     @relation(fields: [bookId], references: [id])
  chapter     Chapter? @relation(fields: [chapterId], references: [id])
  
  @@unique([userId, bookId])
}

model ReadingStatus_info {
  readingstatusId        Int      @id @default(autoincrement())
  userId    Int
  date      DateTime @default(now()) // 统计日期
  readingTime Int    @default(0) // 当日阅读时长(分钟)
  
  user      User     @relation(fields: [userId], references: [id])
}

model TrialCardIncentive_info {
  incentiveId          Int               @id @default(autoincrement())
  userId               Int               @unique // 确保每个用户最多只有一条记录
  isEligible           Boolean           @default(true) // 是否满足条件
  
  // 实际发放的体验卡 ID，用于追踪
  grantedCardId        Int?              @unique 
  grantedAt            DateTime          @default(now())

  user                 User_info         @relation(fields: [userId], references: [userId])
  grantedCard          TrialCard_info?   @relation(fields: [grantedCardId], references: [cardId])
}

model TrialCard_info {
  cardId               Int               @id @default(autoincrement())
  code                 String            @unique // 兑换码或系统生成码
  durationDays         Int               // 体验时长（天）
  
  // 激活信息
  isActivated          Boolean           @default(false)
  activatedAt          DateTime?
  
  activatedByUserId    Int?              @unique 
  trialEndDate         DateTime?         // 体验卡权益截止日期

  createdAt            DateTime          @default(now())

  // 关联到激活该卡的用户
  activatedByUser      User_info?        @relation("UserActiveTrialCard", fields: [activatedByUserId], references: [userId])
  
  // 关联到激励记录（表明该卡是因激励而发的）
  incentiveRecord      TrialCardIncentive_info? @relation("IncentiveCard")

  // 关联激励记录
  incentiveRecord      TrialCardIncentive_info?
}

model Note_info {
  noteId        Int       @id @default(autoincrement())
  userId    Int
  bookId    Int
  chapterId Int?
  content   String
  type      String    @default("highlight") // highlight, comment
  color     String?   // 标注颜色
  page      Int?
  isPublic  Boolean   @default(false)
  createdAt DateTime  @default(now())
  
  user      User      @relation(fields: [userId], references: [id])
  book      Book      @relation(fields: [bookId], references: [id])
  chapter   Chapter?  @relation(fields: [chapterId], references: [id])
  likes     Like[]
}

model Bookmark_info {
  bookmarkId        Int      @id @default(autoincrement())
  userId    Int
  bookId    Int
  chapterId Int?
  page      Int
  note      String?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  book      Book     @relation(fields: [bookId], references: [id])
  chapter   Chapter? @relation(fields: [chapterId], references: [id])
}

model Post_info {
  postId        Int       @id @default(autoincrement())
  userId    Int
  bookId    Int?
  title     String
  content   String    @db.Text
  topic     String?   // 话题分类
  isPublic  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  user      User      @relation(fields: [userId], references: [id])
  book      Book?     @relation(fields: [bookId], references: [id])
  comments  Comment[]
  likes     Like[]
}

model Comment_info {
  commentId        Int       @id @default(autoincrement())
  userId    Int
  postId    Int?
  noteId    Int?
  parentId  Int?      // 回复的评论ID
  content   String    @db.Text
  createdAt DateTime  @default(now())
  
  user      User      @relation(fields: [userId], references: [id])
  post      Post?     @relation(fields: [postId], references: [id])
  note      Note?     @relation(fields: [noteId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  likes     Like[]
}

model Like_info {
  likeId        Int       @id @default(autoincrement())
  userId    Int
  postId    Int?
  commentId Int?
  noteId    Int?
  createdAt DateTime  @default(now())
  
  user      User      @relation(fields: [userId], references: [id])
  post      Post?     @relation(fields: [postId], references: [id])
  comment   Comment?  @relation(fields: [commentId], references: [id])
  note      Note?     @relation(fields: [noteId], references: [id])
  
  @@unique([userId, postId, commentId, noteId])
}

model Follow_info {
  followId          Int      @id @default(autoincrement())
  followerId  Int      // 关注者
  followingId Int      // 被关注者
  createdAt   DateTime @default(now())
  
  follower    User     @relation("Follower", fields: [followerId], references: [id])
  following   User     @relation("Following", fields: [followingId], references: [id])
  
  @@unique([followerId, followingId])
}

model Message_info {
  messageId        Int       @id @default(autoincrement())
  userId    Int
  type      String    // system, like, comment, follow
  title     String
  content   String
  isRead    Boolean   @default(false)
  relatedId Int?      // 相关实体ID
  createdAt DateTime  @default(now())
  
  user      User      @relation(fields: [userId], references: [id])
}

model VerificationCode_info {
  vertificationcodeId        Int      @id @default(autoincrement())
  phone     String?
  email     String?
  code      String
  type      String   // login, register, reset
  expiresAt DateTime
  createdAt DateTime @default(now())
}