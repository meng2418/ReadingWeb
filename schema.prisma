// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // 或 "mysql", "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// 核心信息表 (Primary Entities)
// ===============================================

model UserInfo {
  userId               Long      @id @default(autoincrement())
  username             String   @unique
  phone                String?  @unique
  password             String?
  avatar               String?
  bio                  String?
  memberEndDate        DateTime
  isMember             Boolean  @default(false)
  coins                Int      @default(0) // 书币
  totalReadingTime     Int      @default(0) // 总阅读时长(分钟)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // 关联关系：已修正为正确的模型名
  bookshelf            Bookshelf_info[]
  readingProgress      ReadingProgress_info[]
  notes                Note_info[]
  bookmarks            Bookmark_info[]
  posts                Post_info[]
  comments             Comment_info[]
  likes                Like_info[]
  follows              Follow_info[]            @relation("Follower")
  followers            Follow_info[]            @relation("Following")
  messages             Message_info[]
  readingStats         ReadingStatus_info[]
  achievementLogs      AchievementLog_info[]
  stat                 UserStat_info? // 新增一对一关联
  memberInfo           Member_info?
  trialBalance         TrialBalance_info?
  bookAccesses         UserBookAccess_info[]
  coinAccount          CoinAccount_info?
}

model CoinAccount_info {
  accountId   Int         @id @default(autoincrement())
  userId      Int         @unique 
  balance     Int         @default(0) // 充值币余额

  user        User_info   @relation(fields: [userId], references: [userId])
  transactions CoinTransaction_info[]

  @@map("coin_account_info")
}

model CoinTransaction_info {
  transactionId Int         @id @default(autoincrement())
  accountId     Int
  amount        Int         // 交易数量 (充值: 正, 消费: 负)
  type          String      // TRANSACTION_TYPE: PURCHASE, DEPOSIT, REWARD
  description   String?
  timestamp     DateTime    @default(now())

  account       CoinAccount_info @relation(fields: [accountId], references: [accountId])

  @@map("coin_transaction_info")
}

model UserStat_info {
  userStatId              Int      @id @default(autoincrement())
  userId              Int      @unique // 与 User_info 一对一关联
  
  // 累计阅读书籍数量
  totalBooksCompleted Int      @default(0)
  
  // 累计笔记数量
  totalNotesCount     Int      @default(0)
  
  // 累计阅读时长 (单位：分钟)
  totalReadingDurationMinutes Int @default(0)

  // 关系：UserStat 依赖 User
  user                User_info @relation(fields: [userId], references: [userId])

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("user_stat_info")
}

model AchievementLog_info {
  logId           Int                 @id @default(autoincrement())
  userId          Int
  
  type            String
  level           Int
  description     String              @db.VarChar(255)
  valueSnapshot   Int

  achievedAt      DateTime            @default(now())

  user            User_info           @relation(fields: [userId], references: [userId])

  @@unique([userId, type, level]) 
  @@map("achievement_log")
}

model LoginLogInfo {
  loginLogid           Int      @id @default(autoincrement())
  userId               Long
  loginTime   DateTime @default(now()) @map("login_time")
  ipAddress   String   @db.VarChar(64) @map("ip_address")
  device      String   @db.VarChar(255)
  status      String   @db.VarChar(20)
  remarks     String?  @db.VarChar(500) // 失败时可能才有备注，所以设为可选
  user        User     @relation(fields: [userId], references: [userId]) 
  
  @@index([userId]) // 常用查询索引，方便按用户查找日志
  @@map("t_login_log") // 映射到数据库表名 t_login_log
}

model AuthorInfo {
  authorId Int      @id @default(autoincrement())
  name     String   @unique // 作者姓名，通常唯一
  bio      String?  @db.Text // 作者简介
  avatar   String?  // 作者头像

  // 关联关系：作者可以写多本书
  books    Book_info[]
}

model BookInfo {
  bookId        Int           @id @default(autoincrement())
  title         String
  authorId      Int           // 外键，关联到作者表
  cover         String?
  description   String?       @db.Text
  categoryId    Int
  publisher     String?
  publishDate   DateTime?
  isbn          String?
  wordCount     Int           // 字数
  price         Int           @default(0) // 书币价格
  isFree        Boolean       @default(false)
  rating        Float         @default(0) // 推荐值
  readCount     Int           @default(0) // 阅读人数
  createdAt     DateTime      @default(now())

  // 关联关系：已修正
  category      Category_info @relation(fields: [categoryId], references: [categoryId])
  author        Author_info   @relation(fields: [authorId], references: [authorId]) // 作者关联

  chapters      Chapter_info[]
  bookshelf     Bookshelf_info[]
  readingProgress ReadingProgress_info[]
  notes         Note_info[]
  bookmarks     Bookmark_info[]
  posts         Post_info[]
  comments      Comment_info[]
}

model CategoryInfo {
  categoryId Int       @id @default(autoincrement())
  name       String
  books      Book_info[] // 修正模型名
}

model ChapterInfo {
  chapterId Int                 @id @default(autoincrement())
  title     String
  content   String              @db.Text
  order     Int
  bookId    Int
  createdAt DateTime            @default(now())
  access    ChapterAccess_info?

  // 修正引用字段
  book      Book_info           @relation(fields: [bookId], references: [bookId])
  notes     Note_info[]
  bookmarks Bookmark_info[]
}


// ===============================================
// 用户行为表 (User Activities)
// ===============================================

model BookshelfInfo {
  bookshelfid Int       @id @default(autoincrement())
  userId      Int
  bookId      Int
  status      String    @default("reading") // reading, unread, finished
  addedAt     DateTime  @default(now())
  lastReadAt  DateTime?

  // 修正引用字段
  user        User_info @relation(fields: [userId], references: [userId])
  book        Book_info @relation(fields: [bookId], references: [bookId])

  @@unique([userId, bookId])
}

model ReadingProgressInfo {
  readingprogressid Int       @id @default(autoincrement())
  userId            Int
  bookId            Int
  chapterId         Int?
  currentPage       Int       @default(1)
  progress          Float     @default(0)  // 0-1
  lastReadAt        DateTime  @default(now())

  // 修正引用字段
  user              User_info      @relation(fields: [userId], references: [userId])
  book              Book_info      @relation(fields: [bookId], references: [bookId])
  chapter           Chapter_info?  @relation(fields: [chapterId], references: [chapterId])

  @@unique([userId, bookId])
}

model ReadingStatusInfo {
  readingstatusId Int       @id @default(autoincrement())
  userId          Int
  date            DateTime  @default(now()) // 统计日期
  readingTime     Int       @default(0) // 当日阅读时长(分钟)

  // 修正引用字段
  user            User_info @relation(fields: [userId], references: [userId])
}

model NoteInfo {
  noteId    Int          @id @default(autoincrement())
  userId    Int
  bookId    Int
  chapterId Int?
  content   String
  type      String       @default("highlight") // highlight, underline, wavy line
  color     String?      // 标注颜色
  page      Int?
  isPublic  Boolean      @default(false)
  createdAt DateTime     @default(now())

  // 修正引用字段
  user      User_info    @relation(fields: [userId], references: [userId])
  book      Book_info    @relation(fields: [bookId], references: [bookId])
  chapter   Chapter_info? @relation(fields: [chapterId], references: [chapterId])
  likes     Like_info[]
}

model BookmarkInfo {
  bookmarkId Int          @id @default(autoincrement())
  userId     Int
  bookId     Int
  chapterId  Int?
  page       Int
  createdAt  DateTime     @default(now())

  // 修正引用字段
  user       User_info     @relation(fields: [userId], references: [userId])
  book       Book_info     @relation(fields: [bookId], references: [bookId])
  chapter    Chapter_info? @relation(fields: [chapterId], references: [chapterId])
}

model PostInfo {
  postId    Int          @id @default(autoincrement())
  userId    Int
  title     String
  content   String       @db.Text
  status   String?      // 帖子状态(例如：0-正常, 1-审核中, 2-已删除)
  isPublic  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // 修正引用字段
  user      User_info    @relation(fields: [userId], references: [userId])
  topics      PostTopic_info[]
  relatedBooks     PostBooknfo[]  
  comments  Comment_info[]
  likes     Like_info[]
}

model PostBook {
  postId        Int
  bookId        Int

  // 关系定义
  post          Post_info       @relation(fields: [postId], references: [postId])
  book          Book_info       @relation(fields: [bookId], references: [bookId])

  // 复合主键
  @@id([postId, bookId])
  @@map("post_book_mapping")
}

model TopicInfo {
  topicId   Int            @id @default(autoincrement())
  topicName String 
  description String

  // 多对多关系的反向关联
  posts       PostTopic_info[] 

  @@map("topic_info")
}

model PostTopicInfo {
  postId    Int
  topicId   Int

  post      PostInfo       @relation(fields: [postId], references: [postId])
  topic     TopicInfo      @relation(fields: [topicId], references: [topicId])

  @@id([postId, topicId])
  @@map("post_topic_info")
}

model CommentInfo {
  commentId Int          @id @default(autoincrement())
  userId    Int
  postId    Int?
  noteId    Int?
  parentcommentId  Int?         // 回复的评论ID
  content   String       @db.Text
  createdAt DateTime     @default(now())

  // 修正引用字段
  user      User_info    @relation(fields: [userId], references: [userId])
  post      Post_info?   @relation(fields: [postId], references: [postId])
  note      Note_info?   @relation(fields: [noteId], references: [noteId])
  
  // 修正引用字段
  parent    Comment_info? @relation("CommentReplies", fields: [parentId], references: [commentId])
  replies   Comment_info[] @relation("CommentReplies")
  likes     Like_info[]
}

model LikeInfo {
  likeId    Int          @id @default(autoincrement())
  userId    Int
  postId    Int?
  commentId Int?
  noteId    Int?
  createdAt DateTime     @default(now())

  // 修正引用字段
  user      User_info    @relation(fields: [userId], references: [userId])
  post      Post_info?   @relation(fields: [postId], references: [postId])
  comment   Comment_info? @relation(fields: [commentId], references: [commentId])
  note      Note_info?   @relation(fields: [noteId], references: [noteId])

  @@unique([userId, postId, commentId, noteId])
}

model FollowInfo {
  followId    Int      @id @default(autoincrement())
  followerId  Int      // 关注者
  followingId Int      // 被关注者
  createdAt   DateTime @default(now())

  // 修正引用字段
  follower    User_info @relation("Follower", fields: [followerId], references: [userId])
  following   User_info @relation("Following", fields: [followingId], references: [userId])

  @@unique([followerId, followingId])
}


// ===============================================
// 会员和体验卡表 (Membership & Trial)
// ===============================================

model Member_info {
  memberId      Int         @id @default(autoincrement())
  userId        Int         @unique 
  expireDate    DateTime    // 会员过期时间
  level         Int         @default(1)

  user          User_info   @relation(fields: [userId], references: [userId])

  @@map("member_info")
}

model TrialBalance_info {
  balanceId     Int         @id @default(autoincrement())
  userId        Int         @unique
  daysBalance   Int         @default(0) // 剩余体验天数

  user          User_info   @relation(fields: [userId], references: [userId])
  rewardLogs    TrialRewardLog_info[] 

  @@map("trial_balance_info")
}

model UserBookAccess_info {
  accessId      Int         @id @default(autoincrement())
  userId        Int
  bookId        Int
  purchaseTime  DateTime    @default(now()) 
  
  // 假设 Book_info 实体存在
  // book          Book_info   @relation(fields: [bookId], references: [bookId])

  @@unique([userId, bookId]) 
  @@map("user_book_access_info")
}

model ChapterAccessInfo {
  accessId      Int           @id @default(autoincrement())
  chapterId     Int           @unique
  
  // 访问级别：free, trial, member
  accessLevel   String        @default("free")

  // 修正引用字段
  chapter       Chapter_info @relation(fields: [chapterId], references: [chapterId])
}

model VerificationCodeInfo {
  vertificationcodeId Int      @id @default(autoincrement())
  phone               String?
  code                String
  type                String   // login, register, reset
  expiresAt           DateTime
  createdAt           DateTime @default(now())
}
